name: Reusable CI/CD base

on:
  workflow_call:
    inputs:
      job-type:
        required: true
        type: string
      clickhouse-versions:
        type: string
        description: 'ClickHouse version as JSON array string (e.g. ''["24.5", "24.6"]'')'
        default: '["24.5","24.6"]'
      platforms:
        type: string
        description: 'Platform(s) for Docker build (e.g., "linux/amd64,linux/arm64")'
        default: "linux/amd64"
      push-image:
        type: boolean
        default: false
      load-image:
        type: boolean
        default: false
      test-container:
        type: boolean
        default: false
      image-tag:
        type: string
        description: "Custom Docker image tag override"

    outputs:
      tags:
        value: ${{ jobs.job.outputs.tags }}
      first_tag:
        value: ${{ jobs.job.outputs.first_tag }}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  job:
    name: ${{ inputs.job-type }}
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      first_tag: ${{ steps.first_tag.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:
        clickhouse-version: ${{ fromJSON(inputs.clickhouse-versions) }}

    services:
      clickhouse:
        image: clickhouse/clickhouse-server:${{ matrix.clickhouse-version }}
        ports:
          - 8123:8123
          - 9000:9000
        env:
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
          CLICKHOUSE_DB: default
          CLICKHOUSE_USER: admin
          CLICKHOUSE_PASSWORD: password
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Next.js Cache
        uses: actions/cache@v5
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      - name: Install dependencies
        run: bun install

      # === Linting ===
      - name: Lint
        if: ${{ inputs.job-type == 'lint' }}
        run: bun run lint

      # === Tests ===
      - name: Run Tests
        if: ${{ inputs.job-type == 'test' }}
        run: bun run test:coverage

      - name: Upload coverage report
        if: ${{ inputs.job-type == 'test' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.clickhouse-version }}
          path: coverage/
          retention-days: 30
          if-no-files-found: ignore

      - name: Test Summary
        if: ${{ inputs.job-type == 'test' && always() }}
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "ClickHouse Version: ${{ matrix.clickhouse-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "coverage" ]; then
            echo "ðŸ“Š Coverage report generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No coverage report found" >> $GITHUB_STEP_SUMMARY
          fi

      # === App Build ===
      - name: Build App
        if: ${{ inputs.job-type == 'build' }}
        run: bun run build

      # === Docker Build ===
      - name: Set up QEMU
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest
        env:
          TMPDIR: /home/runner/work/_temp

      - name: Login to Container registry
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        if: ${{ inputs.job-type == 'docker' }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Branch name (e.g., main) - for main branch builds
            type=ref,event=branch
            # PR number - for PR builds
            type=ref,event=pr
            # Full version (e.g., 0.2.0, 0.2.0-beta.1)
            type=semver,pattern={{version}}
            # Major.Minor (e.g., 0.2) - only for stable releases, not pre-releases
            type=semver,pattern={{major}}.{{minor}}
            # Major version (e.g., 0) - only for stable releases, not pre-releases
            type=semver,pattern={{major}}
            # Latest tag - for main branch and stable releases only (not pre-releases)
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, '-')) }}
            # Main tag - for main branch and all releases (stable and pre-release)
            type=raw,value=main,enable=${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
            # SHA for uniqueness
            type=sha,prefix=

      - name: Extract first tag
        if: ${{ inputs.job-type == 'docker' && inputs.test-container }}
        id: first_tag
        uses: actions/github-script@v7
        with:
          script: |
            const tags = JSON.parse('${{ steps.meta.outputs.json }}').tags;
            core.setOutput('tag', tags[0]);

      - name: Build and push Docker image
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/build-push-action@v6
        env:
          TMPDIR: /home/runner/work/_temp
        with:
          push: ${{ inputs.push-image }}
          load: ${{ inputs.load-image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}
          # Multi-layered cache strategy: registry (primary) + GitHub Actions (fallback)
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
            type=gha,scope=buildkit
          cache-to: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
            type=gha,mode=max,scope=buildkit
          platforms: ${{ inputs.platforms }}

      # === Container Testing ===
      - name: Test container
        if: ${{ inputs.job-type == 'docker' && inputs.test-container }}
        env:
          TAG: ${{ steps.first_tag.outputs.tag }}
        run: |
          docker run -d \
            --name test-app \
            --network host \
            -e CLICKHOUSE_HOST=localhost \
            -e CLICKHOUSE_PORT=8123 \
            -e CLICKHOUSE_SECURE=false \
            -e LENS_USER=admin \
            -e LENS_PASSWORD=password \
            -e SESSION_SECRET=complex_password_at_least_32_characters_long_for_security\
            "$TAG"

          # Wait for container health
          timeout 60 bash -c 'until curl -sSf http://localhost:3000/ > /dev/null 2>&1; do sleep 2; done'

          # Health checks
          curl -sSf http://localhost:3000/ | grep -qi "clicklens"
